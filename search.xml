<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>基于Qt进行简单D-Bus的使用</title>
      <link href="/2024/08/08/%E5%9F%BA%E4%BA%8EQt%E8%BF%9B%E8%A1%8C%E7%AE%80%E5%8D%95D-Bus%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
      <url>/2024/08/08/%E5%9F%BA%E4%BA%8EQt%E8%BF%9B%E8%A1%8C%E7%AE%80%E5%8D%95D-Bus%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="1-概念"><a href="#1-概念" class="headerlink" title="1 概念"></a>1 概念</h1><h2 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h2><p><strong>D-Bus</strong>是一种用于<strong>进程间通信 (IPC) 的消息总线系统</strong>，它使得应用程序可以在不同的进程之间交换数据和调用远程过程。<strong>D-Bus</strong>被广泛应用于<strong>Linux桌面环境</strong>中，如<strong>GNOME</strong>和<strong>KDE</strong>。</p><h2 id="1-2-组件与功能"><a href="#1-2-组件与功能" class="headerlink" title="1.2 组件与功能"></a>1.2 组件与功能</h2><ol><li><p><strong>Bus（总线）</strong>：</p><ul><li>总线是进程间通信的基础。</li><li>一个系统通常有一个“系统总线”供所有用户和服务使用，还有一个“会话总线”为每个用户的登录会话提供服务。</li></ul></li><li><p><strong>Message（消息）</strong>：</p><ul><li>所有通信都通过消息完成。</li><li>消息类型包括方法调用、信号和错误。</li></ul></li><li><p><strong>Object Path（对象路径）</strong>：</p><ul><li>类似于文件系统的路径，用于标识特定的接口实例。</li></ul></li><li><p><strong>Interface（接口）</strong>：</p><ul><li>定义了一组方法、信号和属性。</li></ul></li><li><p><strong>Method（方法）</strong>：</p><ul><li>接口提供的功能。</li></ul></li><li><p><strong>Signal（信号）</strong>：</p><ul><li>事件通知。</li></ul></li><li><p><strong>Property（属性）</strong>：</p><ul><li>对象的状态信息。</li></ul></li></ol><h1 id="2-基本步骤"><a href="#2-基本步骤" class="headerlink" title="2 基本步骤"></a>2 基本步骤</h1><ol><li><p><strong>安装必要的软件包</strong>：</p><ul><li><p>在大多数 Linux 发行版中，D-Bus 库通常已经预先安装，可以通过查看版本确定：<br>  <code>dbus-binding-tool --version</code></p></li><li><p>如果没安装好则安装：<code>sudo apt-get install libdbus-1-dev</code></p></li></ul></li><li><p><strong>编写客户端或服务端代码</strong>：</p><ul><li>使用 C, Python, Java 或其他支持的语言来编写代码。</li><li>使用 <code>g_dbus_code_generator</code> 或类似的工具生成绑定代码。</li></ul></li><li><p><strong>注册服务</strong>：</p><ul><li>服务需要注册到总线上才能接收请求。</li><li>可以通过 <code>dbus-daemon</code> 命令手动启动总线守护进程，或者在系统启动时自动启动。</li></ul></li><li><p><strong>发送和接收消息</strong>：</p><ul><li>客户端发送方法调用消息。</li><li>服务端处理这些消息并返回结果或发送信号。</li></ul></li></ol><h1 id="3-Qt关于D-Bus的组件"><a href="#3-Qt关于D-Bus的组件" class="headerlink" title="3 Qt关于D-Bus的组件"></a>3 Qt关于D-Bus的组件</h1><ol><li><p><strong>QDBusConnection</strong>：</p><ul><li>代表 D-Bus 连接。</li><li>用于注册服务、获取连接等操作。</li></ul></li><li><p><strong>QDBusInterface</strong>：</p><ul><li>用于访问远程对象的接口。</li><li>支持同步和异步调用。</li></ul></li><li><p><strong>QDBusMessage</strong>：</p><ul><li>用于发送低级别的消息。</li><li>通常用于不需要返回值的情况。</li></ul></li><li><p><strong>QDBusObjectPath</strong>：</p><ul><li>用于标识对象路径。</li></ul></li><li><p><strong>QDBusArgument</strong>：</p><ul><li>用于序列化和反序列化 D-Bus 参数。</li></ul></li><li><p><strong>QDBusServiceWatcher</strong>：</p><ul><li>监控服务是否出现在总线上。</li></ul></li><li><p><strong>QDBusAdapter</strong>：</p><ul><li>适配器模式，用于简化 D-Bus 的使用。</li></ul></li></ol><h1 id="4-Qt具体实现"><a href="#4-Qt具体实现" class="headerlink" title="4 Qt具体实现"></a>4 Qt具体实现</h1><h2 id="4-1-服务端"><a href="#4-1-服务端" class="headerlink" title="4.1 服务端"></a>4.1 服务端</h2><h3 id="4-1-1-CMakeLists"><a href="#4-1-1-CMakeLists" class="headerlink" title="4.1.1 CMakeLists"></a>4.1.1 CMakeLists</h3><ul><li>其中的<strong>MOC（Meta-Object Compiler）处理</strong>，在使用Qt库时是必须的，通常<strong>Qt6 CMake</strong>会自动完成构建，无需这样手动显示处理。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.5)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">project(demoserver LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">set(CMAKE_INCLUDE_CURRENT_DIR ON)</span><br><span class="line">set(CMAKE_AUTOUIC ON)</span><br><span class="line">set(CMAKE_AUTOMOC ON)</span><br><span class="line">set(CMAKE_AUTORCC ON)</span><br><span class="line">set(CMAKE_CXX_STANDARD 11)</span><br><span class="line">set(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#添加Qt中的DBus库</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">find_package(Qt5 COMPONENTS Core Widgets DBus REQUIRED)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">add_executable(demoserver</span><br><span class="line"></span><br><span class="line">  main.cpp</span><br><span class="line">  </span><br><span class="line">  dbusmanager.cpp</span><br><span class="line"></span><br><span class="line">  dbusmanager.h</span><br><span class="line"></span><br><span class="line">  myserver.cpp</span><br><span class="line"></span><br><span class="line">  myserver.h</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># MOC（Meta-Object Compiler）处理</span><br><span class="line"></span><br><span class="line">#将包含QObject宏的头文件放进MOC_SRCS变量中</span><br><span class="line"></span><br><span class="line">#qt5_wrap_cpp生成MOC处理后的源文件</span><br><span class="line"></span><br><span class="line">#然后将其添加到项目中</span><br><span class="line"></span><br><span class="line">set(MOC_SRCS $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/myserver.h)</span><br><span class="line"></span><br><span class="line">qt5_wrap_cpp(MOCS $&#123;MOC_SRCS&#125;)</span><br><span class="line"></span><br><span class="line">target_sources(demoserver PRIVATE $&#123;MOCS&#125;)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#链接DBus库</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">target_link_libraries(demoserver Qt5::Core Qt5::DBus)</span><br></pre></td></tr></table></figure><h3 id="4-1-2-myserver-h"><a href="#4-1-2-myserver-h" class="headerlink" title="4.1.2 myserver.h"></a>4.1.2 myserver.h</h3><ul><li>只包含接口方法</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MYSERVER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYSERVER_H</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QObject&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDBusConnection&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//用于创建DBus适配器</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDBusAbstractAdaptor&gt;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyServer</span> : <span class="keyword">public</span> QObject</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment">//Q_CLASSINFO为类提供额外的元信息</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//告诉Qt该类将作为D-Bus接口暴露给其他应用程序</span></span><br><span class="line">    <span class="comment">//也就是设置接口名</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">Q_CLASSINFO</span>(<span class="string">&quot;D-Bus Interface&quot;</span>, <span class="string">&quot;com.example.MyInterface&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">MyServer</span><span class="params">(QObject *parent = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"> Q_SIGNALS:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">shotSignals</span><span class="params">(QString)</span></span>;</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//对于 D-Bus，`slots` 可以简单地理解为普通的成员函数</span></span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line"></span><br><span class="line">    <span class="function">QString <span class="title">echo</span><span class="params">(<span class="type">const</span> QString &amp;message)</span></span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// MYSERVER_H</span></span></span><br></pre></td></tr></table></figure><h3 id="4-1-3-myserver-cpp"><a href="#4-1-3-myserver-cpp" class="headerlink" title="4.1.3 myserver.cpp"></a>4.1.3 myserver.cpp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myserver.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">MyServer::<span class="built_in">MyServer</span>(QObject *parent) : <span class="built_in">QObject</span>(parent)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="function">QString <span class="title">MyServer::echo</span><span class="params">(<span class="type">const</span> QString &amp;message)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Q_EMIT <span class="title">shotSignals</span><span class="params">(<span class="string">&quot;plz kill me..&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Echo: &quot;</span> + message;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-1-4-dbusmanager-h"><a href="#4-1-4-dbusmanager-h" class="headerlink" title="4.1.4 dbusmanager.h"></a>4.1.4 dbusmanager.h</h3><ul><li>用来管理服务的创建和关闭</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DBUSMANAGER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBUSMANAGER_H</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QObject&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myserver.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DbusManager</span> : <span class="keyword">public</span> QObject</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DbusManager</span>();</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Q_SLOTS:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭服务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">doCloseDBus</span><span class="params">(QString msg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">    MyServer *m_pServer = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DBUSMANAGER_H</span></span></span><br></pre></td></tr></table></figure><h3 id="4-1-5-dbusmanager-cpp"><a href="#4-1-5-dbusmanager-cpp" class="headerlink" title="4.1.5 dbusmanager.cpp"></a>4.1.5 dbusmanager.cpp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;dbusmanager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">DbusManager::<span class="built_in">DbusManager</span>(): <span class="built_in">m_pServer</span>(<span class="literal">nullptr</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//在管理类的构造函数中初始化服务端</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    m_pServer = <span class="keyword">new</span> <span class="built_in">MyServer</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册服务到D-Bus</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//QDBusConnection::sessionBus()获取会话总线的连接</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//registerService尝试在D-Bus注册一个服务名称，名称要符合D-Bus命名规范</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!QDBusConnection::<span class="built_in">sessionBus</span>().<span class="built_in">registerService</span>(<span class="string">&quot;com.example.MyService&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">qWarning</span>() &lt;&lt; <span class="string">&quot;Cannot register the service&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册对象到D-Bus</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//registerObject的两个参数分别是对象路径和要注册的对象指针</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里的对象指针通常是包含Q_CLASSINFO(&quot;D-Bus Interface&quot;, &quot;com.example.MyService&quot;)的类</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//或继承自QDBusAbstractAdaptor的类</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!QDBusConnection::<span class="built_in">sessionBus</span>().<span class="built_in">registerObject</span>(<span class="string">&quot;/MyServer&quot;</span>, m_pServer,QDBusConnection::ExportAllSlots | QDBusConnection::ExportAllSignals)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">qWarning</span>() &lt;&lt; <span class="string">&quot;Cannot register the object&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="built_in">qInfo</span>() &lt;&lt; <span class="string">&quot;Service registered and ready to accept connections&quot;</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//服务本身发出杀死自己的信号，管理器接收并执行</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(m_pServer, &amp;MyServer::shotSignals, <span class="keyword">this</span>, &amp;DbusManager::doCloseDBus);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DbusManager::doCloseDBus</span><span class="params">(QString msg)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (QDBusConnection::<span class="built_in">sessionBus</span>().<span class="built_in">unregisterService</span>(<span class="string">&quot;com.example.MyService&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        QDBusConnection::<span class="built_in">sessionBus</span>().<span class="built_in">unregisterObject</span>(<span class="string">&quot;/MyServer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> m_pServer;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-1-6-main-cpp"><a href="#4-1-6-main-cpp" class="headerlink" title="4.1.6 main.cpp"></a>4.1.6 main.cpp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QCoreApplication&gt;</span>  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myserver.h&quot;</span>  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span>  </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="function">QCoreApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//创建管理类对象</span></span><br><span class="line">    DbusManager dbusManger;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">exec</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-2-客户端"><a href="#4-2-客户端" class="headerlink" title="4.2 客户端"></a>4.2 客户端</h2><ul><li><p>在Qt中，编写一个D-Bus客户端以与先前注册的D-Bus服务（如服务器）交互，通常涉及以下几个步骤：</p><ol><li>连接到D-Bus会话总线。</li><li>使用服务名称和对象路径来查找接口。</li><li>调用接口上的方法或访问其属性。</li></ol></li></ul><h3 id="4-2-1-CMakeLists-txt"><a href="#4-2-1-CMakeLists-txt" class="headerlink" title="4.2.1 CMakeLists.txt"></a>4.2.1 CMakeLists.txt</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cmake_minimum_required</span>(VERSION <span class="number">3.5</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="built_in">project</span>(democlient LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_INCLUDE_CURRENT_DIR ON)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_AUTOUIC ON)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_AUTOMOC ON)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_AUTORCC ON)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="built_in">find_package</span>(Qt5 COMPONENTS Widgets Core DBus REQUIRED)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="built_in">add_executable</span>(democlient</span><br><span class="line"></span><br><span class="line">  main.cpp</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">target_link_libraries</span>(democlient Qt5::Core Qt5::DBus)</span><br></pre></td></tr></table></figure><h3 id="4-2-2-main-cpp"><a href="#4-2-2-main-cpp" class="headerlink" title="4.2.2 main.cpp"></a>4.2.2 main.cpp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QCoreApplication&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDBusConnection&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDBusInterface&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//处理远程调用返回的数据</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDBusReply&gt;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">QCoreApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 D-Bus 接口</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//参数分别为注册的服务器名称，服务的对象路径，想要使用的接口的名称，总线类型</span></span><br><span class="line"></span><br><span class="line">    <span class="function">QDBusInterface <span class="title">interface</span><span class="params">(<span class="string">&quot;com.example.MyService&quot;</span>, <span class="string">&quot;/MyServer&quot;</span>, <span class="string">&quot;com.example.MyInterface&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                             QDBusConnection::sessionBus())</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//检测接口是否有效</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!interface.<span class="built_in">isValid</span>()) &#123;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">        <span class="built_in">qCritical</span>() &lt;&lt; <span class="string">&quot;Cannot create a valid D-Bus interface&quot;</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 echo 方法，call函数的两个参数分别为调用的方法名和参数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//QDBusReply作为一个模板接受服务端运行方法返回的信息</span></span><br><span class="line"></span><br><span class="line">    QDBusReply&lt;QString&gt; reply = interface.<span class="built_in">call</span>(<span class="string">&quot;echo&quot;</span>, <span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reply.<span class="built_in">isValid</span>()) &#123;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Received echo:&quot;</span> &lt;&lt; reply.<span class="built_in">value</span>();</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">        <span class="built_in">qCritical</span>() &lt;&lt; <span class="string">&quot;Error calling method:&quot;</span> &lt;&lt; reply.<span class="built_in">error</span>().<span class="built_in">message</span>();</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">exec</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-3-遇到问题"><a href="#4-3-遇到问题" class="headerlink" title="4.3 遇到问题"></a>4.3 遇到问题</h2><h3 id="4-3-1-问题一"><a href="#4-3-1-问题一" class="headerlink" title="4.3.1 问题一"></a>4.3.1 问题一</h3><p>1、一开始服务端运行成功，后来一直运行失败，怀疑是之前的服务没有关闭。</p><p>2、调用<code>qdubs com.example.MyService</code>命令去查看，但报错<code>qdbus: could not find a Qt installation of &#39;&#39;</code></p><p>3、<strong>dbus</strong>需要访问<strong>Qt</strong>的插件，于是设置<code>QT_PLUGIN_PATH</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;export QT_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/qt5/plugins&#x27; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><p>4、其中<strong>Qt路径</strong>通过<code>qmake -query</code>查询,可以看到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QT_INSTALL_PLUGINS:/usr/lib/aarch64-linux-gnu/qt5/plugins</span><br></pre></td></tr></table></figure><p>5、依旧报错，且调用<code>qdbus -v</code>也会报同样错误。于是去查询到的插件目录里寻找，没有找到<code>libqdbus.so</code></p><p>6、安装<strong>QtDbus开发库</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libqt5dbus5-dev</span><br></pre></td></tr></table></figure><p>7、报错没有这个软件包，调用其他命令安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install qtbase5-dev</span><br></pre></td></tr></table></figure><p>8、安装完发现插件目录里依然没有<code>libqdbus.so</code></p><p>9、最后放弃使用<code>qdbus</code>，改为使用<code>d-feet</code>，先安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install d-feet</span><br></pre></td></tr></table></figure><p>10、打开后发现确实没关闭之前的服务</p><h3 id="4-3-2-问题二"><a href="#4-3-2-问题二" class="headerlink" title="4.3.2 问题二"></a>4.3.2 问题二</h3><p>1、 由上个问题中发现服务中没有预想的接口和方法</p><p>2、由于不是将特定的<code>QDBusAbstractAdaptor</code>的方法导出，而是将类中所有方法导出，所以做以下修改，问题解决。</p><p>原：（这时默认参数为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool registerObject(const QString &amp;path, QObject *object,RegisterOptions options = ExportAdaptors);</span><br></pre></td></tr></table></figure><p>）</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!QDBusConnection: :<span class="built_in">sessionBus</span>().<span class="built_in">registerObject</span>(<span class="string">&quot;/&quot;</span>, <span class="keyword">this</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">qWarning</span>() &lt;&lt; <span class="string">&quot;Cannot register the object&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!QDBusConnection: :<span class="built_in">sessionBus</span>().<span class="built_in">registerObject</span>(<span class="string">&quot;/&quot;</span>, <span class="keyword">this</span>，</span><br><span class="line"> QDBusConnection: :ExportAllSlots |</span><br><span class="line">QDBusConnection: :ExportAllSignals)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">qWarning</span>() &lt;&lt; <span class="string">&quot;Cannot register the object&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="5-依靠QDBusAbstractAdaptor的改良实现"><a href="#5-依靠QDBusAbstractAdaptor的改良实现" class="headerlink" title="5 依靠QDBusAbstractAdaptor的改良实现"></a>5 依靠QDBusAbstractAdaptor的改良实现</h1><ul><li><p>改良原因：前一种服务端再被调用时直接将所有的槽函数暴露，这里通过添加一个继承自<code>QDBusAbstractApator</code>类的<code>MyServerApator</code>来更细化的管理接口和方法</p></li><li><p>功能分配：<code>MyServer</code> 类持有 <code>MyServerAdaptor</code> 的实例，并在构造函数中创建适配器。<code>MyServerAdaptor</code> 负责实现 <code>echo</code> 方法并通过 D-Bus 发送信号。<code>DbusManager</code> 类则负责注册服务和对象，并监听信号以便在接收到信号时关闭服务。</p></li><li><p>细节变化：</p><p>  注册对象时不再需要设定参数<br>  <code>QDBusConnection: :ExportAllSlots |QDBusConnection: :ExportAllSignals</code></p></li></ul><h2 id="5-1-myserver-h"><a href="#5-1-myserver-h" class="headerlink" title="5.1 myserver.h"></a>5.1 myserver.h</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MYSERVER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYSERVER_H</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QObject&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myserveradaptor.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyServer</span> : <span class="keyword">public</span> QObject</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Q_OBJECT</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">Q_CLASSINFO</span><span class="params">(<span class="string">&quot;D-Bus Interface&quot;</span>,<span class="string">&quot;com.example.MyInterface&quot;</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">public</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    explicit MyServer(QObject *parent =</span> <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过一个成员函数返回m_adaptor</span></span><br><span class="line"></span><br><span class="line">    <span class="function">MyServerAdaptor* <span class="title">data</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    MyServerAdaptor* m_adaptor=<span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// MYSERVER_H</span></span></span><br></pre></td></tr></table></figure><h2 id="5-2-myserver-cpp"><a href="#5-2-myserver-cpp" class="headerlink" title="5.2 myserver.cpp"></a>5.2 myserver.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myserver.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">MyServer::<span class="built_in">MyServer</span>(QObject *parent) : <span class="built_in">QObject</span>(parent),<span class="built_in">m_adaptor</span>(<span class="keyword">new</span> <span class="built_in">MyServerAdaptor</span>(<span class="keyword">this</span>))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">MyServerAdaptor* <span class="title">MyServer::data</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> m_adaptor;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-3-myserveradaptor-h"><a href="#5-3-myserveradaptor-h" class="headerlink" title="5.3 myserveradaptor.h"></a>5.3 myserveradaptor.h</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MYSERVERAPATOR_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYSERVERAPATOR_H</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QObject&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDBusAbstractAdaptor&gt;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyServerAdaptor</span> : <span class="keyword">public</span> QDBusAbstractAdaptor</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Q_OBJECT</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">Q_CLASSINFO</span><span class="params">(<span class="string">&quot;D-Bus Interface&quot;</span>,<span class="string">&quot;com.example.MyInterface&quot;</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">public</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    explicit MyServerAdaptor(QObject *parent =</span> <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">closeService</span><span class="params">(QString message)</span></span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Q_SLOTS:</span><br><span class="line"></span><br><span class="line">    <span class="function">QString <span class="title">echo</span><span class="params">(QString message)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// MYSERVERAPATOR_H</span></span></span><br></pre></td></tr></table></figure><h2 id="5-4-myserveradaptor-cpp"><a href="#5-4-myserveradaptor-cpp" class="headerlink" title="5.4 myserveradaptor.cpp"></a>5.4 myserveradaptor.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myserveradaptor.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">//这里记得初始化基类QDBusAbstractAdaptor的值</span></span><br><span class="line"></span><br><span class="line">MyServerAdaptor::<span class="built_in">MyServerAdaptor</span>(QObject *parent) : <span class="built_in">QDBusAbstractAdaptor</span>(parent)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">QString <span class="title">MyServerAdaptor::echo</span><span class="params">(QString message)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Q_EMIT <span class="title">closeService</span><span class="params">(<span class="string">&quot;please kill me...&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Echo:&quot;</span>+message;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-5-dbusmanager-h"><a href="#5-5-dbusmanager-h" class="headerlink" title="5.5 dbusmanager.h"></a>5.5 dbusmanager.h</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DBUSMANAGER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBUSMANAGER_H</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QObject&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myserver.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DbusManager</span> : <span class="keyword">public</span> QObject</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">DbusManager</span><span class="params">(QObject *parent = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Q_SLOTS:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">doCloseDBus</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">    MyServer *m_pServer=<span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DBUSMANAGER_H</span></span></span><br></pre></td></tr></table></figure><h2 id="5-6-dbusmanager-cpp"><a href="#5-6-dbusmanager-cpp" class="headerlink" title="5.6 dbusmanager.cpp"></a>5.6 dbusmanager.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;dbusmanager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDBusConnection&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">DbusManager::<span class="built_in">DbusManager</span>(QObject *parent) : <span class="built_in">QObject</span>(parent),<span class="built_in">m_pServer</span>(<span class="keyword">new</span> <span class="built_in">MyServer</span>(<span class="keyword">this</span>))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!QDBusConnection::<span class="built_in">sessionBus</span>().<span class="built_in">registerService</span>(<span class="string">&quot;com.example.MyService&quot;</span>))&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">qWarning</span>()&lt;&lt;<span class="string">&quot;Cannot register the service&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!QDBusConnection::<span class="built_in">sessionBus</span>().<span class="built_in">registerObject</span>(<span class="string">&quot;/MyServer&quot;</span>,m_pServer))&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">qWarning</span>() &lt;&lt; <span class="string">&quot;Cannot register the object&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qInfo</span>() &lt;&lt; <span class="string">&quot;Service registered and ready to accept connections&quot;</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(m_pServer-&gt;<span class="built_in">data</span>(), &amp;MyServerAdaptor::closeService, <span class="keyword">this</span>, &amp;DbusManager::doCloseDBus);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DbusManager::doCloseDBus</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(QDBusConnection::<span class="built_in">sessionBus</span>().<span class="built_in">unregisterService</span>(<span class="string">&quot;com.example.MyService&quot;</span>))&#123;</span><br><span class="line"></span><br><span class="line">        QDBusConnection::<span class="built_in">sessionBus</span>().<span class="built_in">unregisterObject</span>(<span class="string">&quot;/MyServer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> m_pServer;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-7-main-cpp"><a href="#5-7-main-cpp" class="headerlink" title="5.7 main.cpp"></a>5.7 main.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QCoreApplication&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;dbusmanager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">QCoreApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    DbusManager myDbusManager;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">exec</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://gitee.com/waibibushixiaobabo/demodbus">demodbus: 基于Qt进行简单D-Bus的使用 (gitee.com)</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> demo项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> demo </tag>
            
            <tag> Qt </tag>
            
            <tag> CMake </tag>
            
            <tag> D-Bus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于Qt的简单动态库的编写与调用</title>
      <link href="/2024/08/06/%E5%9F%BA%E4%BA%8EQt%E7%9A%84%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%BA%93%E7%9A%84%E7%BC%96%E5%86%99%E4%B8%8E%E8%B0%83%E7%94%A8/"/>
      <url>/2024/08/06/%E5%9F%BA%E4%BA%8EQt%E7%9A%84%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%BA%93%E7%9A%84%E7%BC%96%E5%86%99%E4%B8%8E%E8%B0%83%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="1-编写库"><a href="#1-编写库" class="headerlink" title="1 编写库"></a>1 编写库</h1><h2 id="1-1-库的入门"><a href="#1-1-库的入门" class="headerlink" title="1.1 库的入门"></a>1.1 库的入门</h2><h3 id="1-1-1-创建一个库"><a href="#1-1-1-创建一个库" class="headerlink" title="1.1.1 创建一个库"></a>1.1.1 创建一个库</h3><p>1、<strong>在Qt creator</strong>中自动创建，选择<strong>Library</strong></p><p><img src="https://1807962239hml-1324287819.cos.ap-beijing.myqcloud.com/202408060848977.png"></p><p>2、选择安装位置及项目名称</p><p>3、因为正在练习<strong>CMake</strong>，所以选择<strong>CMake</strong>为构建方式</p><p><img src="https://1807962239hml-1324287819.cos.ap-beijing.myqcloud.com/202408060852619.png"></p><p>4、继续选择是<strong>动态库、静态库还是插件</strong>；选择库中第一个类的名称，以及选择需要包含的Qt组件</p><ul><li>这里创建的<strong>动态库</strong></li></ul><p><img src="https://1807962239hml-1324287819.cos.ap-beijing.myqcloud.com/202408060856903.png"></p><p>5、后续Kits等基本选择默认设置就可以</p><h3 id="1-1-2-库的目录结构"><a href="#1-1-2-库的目录结构" class="headerlink" title="1.1.2 库的目录结构"></a>1.1.2 库的目录结构</h3><p>以下为一个用CMake构建的简单库的主要目录结构</p><p><img src="https://1807962239hml-1324287819.cos.ap-beijing.myqcloud.com/202408060905999.png"></p><p>1、<strong>CMakeLists.txt</strong>是构建项目的配置文件</p><p>2、<strong>MyLibrary_global.h</strong>是全局头文件，用来定义库的一些<strong>基本配置、宏、类型定义等</strong></p><p>3、剩下是库的<strong>头文件和源文件</strong></p><h2 id="1-2-具体代码及解析"><a href="#1-2-具体代码及解析" class="headerlink" title="1.2 具体代码及解析"></a>1.2 具体代码及解析</h2><h3 id="1-2-1-CMakeLists-txt"><a href="#1-2-1-CMakeLists-txt" class="headerlink" title="1.2.1 CMakeLists.txt"></a>1.2.1 CMakeLists.txt</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">#设置需要的cmake的最小版本</span><br><span class="line"></span><br><span class="line">cmake_minimum_required(VERSION <span class="number">3.5</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">#设置项目名称</span><br><span class="line"></span><br><span class="line">project(MyLibrary LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">#设置一些基础变量</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_INCLUDE_CURRENT_DIR ON)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_AUTOUIC ON)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_AUTOMOC ON)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_AUTORCC ON)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#找Qt5中的Widgets组件</span><br><span class="line">#COMPONENTS关键字代表找特定的组件</span><br><span class="line">#REQUIRED关键字代表组件是必须的，没有找到会直接构建失败</span><br><span class="line"></span><br><span class="line">find_package(Qt5 COMPONENTS Widgets REQUIRED)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">#添加库中所包含的文件</span><br><span class="line"></span><br><span class="line">add_library(MyLibrary SHARED</span><br><span class="line"></span><br><span class="line">  MyLibrary_global.h</span><br><span class="line"></span><br><span class="line">  mylibrary.cpp</span><br><span class="line"></span><br><span class="line">  mylibrary.h</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#设置安装前缀</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_INSTALL_PREFIX <span class="string">&quot;/home/hml/文档/test&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#file（GLOB 变量名 某路径下的某格式） 这里的路径默认为当前项目目录</span></span><br><span class="line">#将项目目录中的头文件存到HEADER_FILES变量中</span><br><span class="line"></span><br><span class="line">file(GLOB HEADER_FILES <span class="string">&quot;*.h&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#将当前库MyLibrary与其他库链接 PRIVATE关键字代表链接信息只对当前目标有效，不会传递</span><br><span class="line"></span><br><span class="line">target_link_libraries(MyLibrary PRIVATE Qt5::Widgets)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#定义一个预处理宏MYLIBRARY_LIBRARY只对目标MyLibrary有效</span><br><span class="line"></span><br><span class="line">target_compile_definitions(MyLibrary PRIVATE MYLIBRARY_LIBRARY)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#设置库的安装位置</span><br><span class="line">#TARGETS指定要安装的目标 LIBRARY代表要安装的是库文件 DESTINATION则是要安装的目标位置</span><br><span class="line">#这里的路径会把前面设置的安装前缀加在一起</span><br><span class="line"></span><br><span class="line">install(TARGETS MyLibrary LIBRARY DESTINATION mylib)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#设置头文件的安装位置</span><br><span class="line">#FILES直接指定要安装的文件列表 $&#123;HEADER_FILES&#125;是前面存放库中头文件的变量</span><br><span class="line"></span><br><span class="line">install(FILES $&#123;HEADER_FILES&#125; DESTINATION mylib/include)</span><br></pre></td></tr></table></figure><h3 id="1-2-2-MyLibrary-global-h"><a href="#1-2-2-MyLibrary-global-h" class="headerlink" title="1.2.2 MyLibrary_global.h"></a>1.2.2 MyLibrary_global.h</h3><ul><li><p>主要用于处理共享库中的符号可见性</p></li><li><p>定义了一个宏 <code>MYLIBRARY_EXPORT</code>，用来决定哪些符号应该被导出或导入到库中</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MYLIBRARY_GLOBAL_H作为一个变量来避免此头文件被重复包含</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MYLIBRARY_GLOBAL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYLIBRARY_GLOBAL_H</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//包含Qt的全局定义头文件</span></span><br><span class="line"><span class="comment">//这个头文件是必要的，因为它包含了宏Q_DECL_EXPORT和Q_DECL_IMPORT</span></span><br><span class="line"><span class="comment">//这两个宏用于控制 Qt 库中的符号可见性。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtCore/qglobal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">//根据MYLIBRARY_LIBRARY来定义符号导出还是导入</span></span><br><span class="line"><span class="comment">//构件库时可导出 使用库时可导入</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(MYLIBRARY_LIBRARY)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> MYLIBRARY_EXPORT Q_DECL_EXPORT</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> MYLIBRARY_EXPORT Q_DECL_IMPORT</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// MYLIBRARY_GLOBAL_H</span></span></span><br></pre></td></tr></table></figure><h3 id="1-2-3-mylibrary-h"><a href="#1-2-3-mylibrary-h" class="headerlink" title="1.2.3 mylibrary.h"></a>1.2.3 mylibrary.h</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MYLIBRARY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYLIBRARY_H</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MyLibrary_global.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">//前面定义MYLIBRARY_EXPORT来控制这个类内容的导入和导出</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MYLIBRARY_EXPORT</span> MyLibrary</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MyLibrary</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getSum</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// MYLIBRARY_H</span></span></span><br></pre></td></tr></table></figure><h3 id="1-2-4-mylibrary-cpp"><a href="#1-2-4-mylibrary-cpp" class="headerlink" title="1.2.4 mylibrary.cpp"></a>1.2.4 mylibrary.cpp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mylibrary.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">MyLibrary::<span class="built_in">MyLibrary</span>()</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MyLibrary::getSum</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-3-CMake编译步骤"><a href="#1-3-CMake编译步骤" class="headerlink" title="1.3 CMake编译步骤"></a>1.3 CMake编译步骤</h2><p>1、cd到项目目录</p><p>2、添加文件夹<strong>build</strong>：<code>mkdir build</code></p><p>3、cd到build</p><p>4、<code>cmake ..</code></p><p>5、<code>make</code></p><p>6、（需要安装库和头文件时：<code>sudo make install</code>）</p><h1 id="2-编写CMake构建的可执行文件"><a href="#2-编写CMake构建的可执行文件" class="headerlink" title="2 编写CMake构建的可执行文件"></a>2 编写CMake构建的可执行文件</h1><h2 id="2-1-CMakeList-txt"><a href="#2-1-CMakeList-txt" class="headerlink" title="2.1 CMakeList.txt"></a>2.1 CMakeList.txt</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION <span class="number">3.5</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">project(MyApp LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_INCLUDE_CURRENT_DIR ON)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_AUTOUIC ON)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_AUTOMOC ON)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_AUTORCC ON)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">find_package(Qt5Core)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#以绝对路径在库的安装位置找到自己编写的库</span><br><span class="line">#LIBRARY_NAME作为变量存储库的名字 PATHS关键字指定绝对路径</span><br><span class="line"></span><br><span class="line">find_library(LIBRARY_NAME MyLibrary PATHS /home/hml/文档/test/mylib)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#添加项目参与编译的文件</span><br><span class="line"></span><br><span class="line">add_executable(MyApp</span><br><span class="line"></span><br><span class="line">  main.cpp</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#链接Qt5的Core库和自己编写的库</span><br><span class="line"></span><br><span class="line">target_link_libraries(MyApp Qt5::Core $&#123;LIBRARY_NAME&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#以绝对路径将自己编写的库中的头文件添加进项目中</span><br><span class="line"></span><br><span class="line">target_include_directories(MyApp PRIVATE /home/hml/文档/test/mylib/include)</span><br></pre></td></tr></table></figure><h2 id="2-2-main-cpp"><a href="#2-2-main-cpp" class="headerlink" title="2.2  main.cpp"></a>2.2  main.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QCoreApplication&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mylibrary.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MyLibrary_global.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">QCoreApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> x=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> y=<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//先创建库的类的实例化对象，再调用其中的成员函数</span></span><br><span class="line"></span><br><span class="line">    MyLibrary* lib=<span class="keyword">new</span> MyLibrary;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> z=lib-&gt;<span class="built_in">getSum</span>(x,y);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;z;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> lib;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">exec</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="3-补充：QMake构建库的方法"><a href="#3-补充：QMake构建库的方法" class="headerlink" title="3 补充：QMake构建库的方法"></a>3 补充：QMake构建库的方法</h1><h2 id="3-1-qmakelibrary-pro"><a href="#3-1-qmakelibrary-pro" class="headerlink" title="3.1 qmakelibrary.pro"></a>3.1 qmakelibrary.pro</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">#减去qt的一些默认配置，表示其不是一个qt的默认程序</span><br><span class="line"></span><br><span class="line">CONFIG -= qt</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#指定项目模板为库</span><br><span class="line"></span><br><span class="line">TEMPLATE = lib</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#添加预处理宏来记录是构建库还是使用库</span><br><span class="line"></span><br><span class="line">DEFINES += QMAKELIBRARY_LIBRARY</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#添加c++11的标准</span><br><span class="line"></span><br><span class="line">CONFIG += c++11</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#添加预处理宏来警告已废弃了qt API</span><br><span class="line"></span><br><span class="line">DEFINES += QT_DEPRECATED_WARNINGS</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#添加源文件</span><br><span class="line"></span><br><span class="line">SOURCES += \</span><br><span class="line"></span><br><span class="line">    qmakelibrary.cpp</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#添加头文件</span><br><span class="line"></span><br><span class="line">HEADERS += \</span><br><span class="line"></span><br><span class="line">    qmakelibrary_global.h \</span><br><span class="line"></span><br><span class="line">    qmakelibrary.h</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">###############以下为安装设置################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#针对unix系统的特定配置，设定库的目标安装路径</span><br><span class="line"></span><br><span class="line">unix &#123;</span><br><span class="line"></span><br><span class="line">    target.path = /home/hml/文档/test/mylib1</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">#如果库的目标路径不为空，则将库安装到目标路径</span><br><span class="line"></span><br><span class="line">!isEmpty(target.path): INSTALLS += target</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#设置安装的头文件和库的目标路径</span><br><span class="line"></span><br><span class="line">#LIB_INSTALL_DIR = /home/hml/文档/test/mylib1</span><br><span class="line"></span><br><span class="line">HEADERS_INSTALL_DIR = /home/hml/文档/test/mylib1/include</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#如果路径存在，则安装头文件到目标位置</span><br><span class="line"></span><br><span class="line">!isEmpty(HEADERS_INSTALL_DIR): INSTALLS += headers</span><br><span class="line"></span><br><span class="line">    headers.path = $$HEADERS_INSTALL_DIR</span><br><span class="line"></span><br><span class="line">    headers.files = $$HEADERS</span><br></pre></td></tr></table></figure><blockquote><p><strong>QMake</strong>安装时不会自动创建目录，需要<code>mkdir -p</code>手动创建</p></blockquote><h2 id="3-2-qmakelibrary-global-h"><a href="#3-2-qmakelibrary-global-h" class="headerlink" title="3.2 qmakelibrary_global.h"></a>3.2 qmakelibrary_global.h</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#ifndef QMAKELIBRARY_GLOBAL_H</span><br><span class="line"></span><br><span class="line">#define QMAKELIBRARY_GLOBAL_H</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//如果Windows和不同系统定义不同的Q_DECL_EXPORT和Q_DECL_IMPORT</span><br><span class="line"></span><br><span class="line">#if defined(_MSC_VER) || defined(WIN64) || defined(_WIN64) || defined(__WIN64__) || defined(WIN32) || defined(_WIN32) || defined(__WIN32__) || defined(__NT__)</span><br><span class="line"></span><br><span class="line">#  define Q_DECL_EXPORT __declspec(dllexport)</span><br><span class="line"></span><br><span class="line">#  define Q_DECL_IMPORT __declspec(dllimport)</span><br><span class="line"></span><br><span class="line">#else</span><br><span class="line"></span><br><span class="line">#  define Q_DECL_EXPORT     __attribute__((visibility(&quot;default&quot;)))</span><br><span class="line"></span><br><span class="line">#  define Q_DECL_IMPORT     __attribute__((visibility(&quot;default&quot;)))</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">//下面和CMake一样</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#if defined(QMAKELIBRARY_LIBRARY)</span><br><span class="line"></span><br><span class="line">#  define QMAKELIBRARY_EXPORT Q_DECL_EXPORT</span><br><span class="line"></span><br><span class="line">#else</span><br><span class="line"></span><br><span class="line">#  define QMAKELIBRARY_EXPORT Q_DECL_IMPORT</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#endif // QMAKELIBRARY_GLOBAL_H</span><br></pre></td></tr></table></figure><h2 id="3-3-QMake编译步骤"><a href="#3-3-QMake编译步骤" class="headerlink" title="3.3 QMake编译步骤"></a>3.3 QMake编译步骤</h2><p>1、cd到项目目录</p><p>2、<code>qmake .pro文件名</code></p><p>3、<code>make</code></p><p>4、（需要安装库和头文件时：<code>sudo make install</code>）</p><h1 id="4-编写QMake构建的可执行文件"><a href="#4-编写QMake构建的可执行文件" class="headerlink" title="4 编写QMake构建的可执行文件"></a>4 编写QMake构建的可执行文件</h1><h2 id="4-1-qmakeapp-pro"><a href="#4-1-qmakeapp-pro" class="headerlink" title="4.1 qmakeapp.pro"></a>4.1 qmakeapp.pro</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">QT -= gui</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">CONFIG += c++11 console</span><br><span class="line"></span><br><span class="line">CONFIG -= app_bundle</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">DEFINES += QT_DEPRECATED_WARNINGS</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">SOURCES += \</span><br><span class="line"></span><br><span class="line">        main.cpp</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#导入库和头文件</span><br><span class="line"></span><br><span class="line">#-L表示文件夹，-l表示文件夹下的具体的库的名字</span><br><span class="line"></span><br><span class="line">#$$PWD是当前项目目录</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">INCLUDEPATH+=/home/hml/文档/test/mylib1/include</span><br><span class="line"></span><br><span class="line">LIBS+=-L/home/hml/文档/test/mylib1 -lqmakelibrary</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">#根据不同系统设置安装路径</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">qnx: target.path = /tmp/$$&#123;TARGET&#125;/bin</span><br><span class="line"></span><br><span class="line">else: unix:!android: target.path = /opt/$$&#123;TARGET&#125;/bin</span><br><span class="line"></span><br><span class="line">!isEmpty(target.path): INSTALLS += target</span><br></pre></td></tr></table></figure><h2 id="4-2-main-cpp"><a href="#4-2-main-cpp" class="headerlink" title="4.2 main.cpp"></a>4.2 main.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QCoreApplication&gt;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;qmakelibrary.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;qmakelibrary_global.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">QCoreApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> x=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> y=<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment">//先创建库的类的实例化对象，再调用其中的成员函数</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    QMakeLibrary* lib=<span class="keyword">new</span> QMakeLibrary;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> z=lib-&gt;<span class="built_in">getSum</span>(x,y);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;z;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> lib;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">exec</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="5-补充：CMake将库和可执行文件绑定为一个工程"><a href="#5-补充：CMake将库和可执行文件绑定为一个工程" class="headerlink" title="5 补充：CMake将库和可执行文件绑定为一个工程"></a>5 补充：CMake将库和可执行文件绑定为一个工程</h1><p>1、创建一个文件夹，并将所有子项目放进来</p><p>2、在文件夹内添加相应的<strong>CMakeLists.txt</strong>并编写</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.5)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">project(libdemo_cmake LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">add_subdirectory(MyApp)</span><br><span class="line"></span><br><span class="line">add_subdirectory(MyLibrary)</span><br></pre></td></tr></table></figure><h1 id="6-源码地址"><a href="#6-源码地址" class="headerlink" title="6 源码地址"></a>6 源码地址</h1><ul><li><p><a href="https://gitee.com/waibibushixiaobabo/libdemo_cmake/tree/master">CMake版本</a></p></li><li><p><a href="https://gitee.com/waibibushixiaobabo/libdemo_qmake/tree/master">QMake版本</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> demo项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> demo </tag>
            
            <tag> Qt </tag>
            
            <tag> CMake </tag>
            
            <tag> QMake </tag>
            
            <tag> 库 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
